# 第一章：用户的密码一定会被盗

乍看这个标题，非常耸动。

但是，我却得无奈的说出这件事实。这个情形不但是事实，而且一天到晚在区块链世界里面发生。

区块链行业无异是当今黑客眼中的肥羊。

因为在这个行业，黑客实施攻击的成本与其他行业可能是一样的，但是投资报酬率却可能是最高的。

## 撞库已是当今热门手段

当今做资安防护的第一个假设，就是「用户的密码」一定会被盗。问题是，如果用户的密码一定会被盗，你如何防御用户的身家安全。

### 什么是「撞库」？

「撞库」这个词，目前在资安界大家已经非常熟悉了。这个词的意思是「撞库是黑客通过收集互联网已泄露的用户和密码信息，生成对应的字典表，尝试批量登陆其他网站后，得到一系列可以登录的用户。 很多用户在不同网站使用的是相同的帐号密码，因此黑客可以通过获取用户在A网站的账户从而尝试登录B网址，这就可以理解为撞库攻击。」

每个用户一生一定会用过很多不同互联网服务，然而，因为基于人类的惰性，很多人用的都是同一套密码同样使用在不同的服务中。很少人会针对不同服务，使用不同套密码。更别说自己养成安全意识，使用「1Password」之类的密码管理软件，这通常只有一些高阶用户或者是程序员才会有的习惯。

而负责开发服务的程序员面对「撞库」这个问题的解决方方很单纯，总会脱口而出：「那我们教育用户 1Password 管理密码」，或「提醒他们要定时换密码」不就得了。

这其实是一个过于单纯的思维。

1. 用户非常懒，不见得想要换密码。
2. 许多用户非技术背景出身，不可能教育他们使用相对较于复杂的软件。
3. 你不可能通知到系统里面所有人。你更不可能「即时」通知到所有人。

所以你能做的，得换个角度。

不是防止黑客开第一道锁。而是让黑客只破第一道锁是图劳而功的，要取得真正有价值的信息，得过至少三道锁。

### 防护手段一：二步验证

二步验证是现在互联网服务里面，正规军必备的一道验证。

我们可以这么比喻，密码很像是印章，拿到密码就如同印章一样。但是真正取钱，你还是得让用户签名。

这个签名，就是所谓的二步验证。

二步验证有几种方式，常见的有：

1. 手机号码简讯验证
2. Google 演算法的二步验证

这个方式，是确保「用户背后为本人」的一个常规手段。

不过，这个方法只适用于一般不敏感的互联网服务。

如果你经营的是区块链交易所的话，建议还是不能单纯只用「手机号码简讯验证」验证。因为这种方法有一些其他的风险性在：

* 比如说用户被不肖份子锁定，手机信号从 4G 被降到 2G，被拦截简信盗号成功。
* 用户的手机被同事拿走，接收简信，假装是本人

当然你会问。那换 Google 演算法就会比较安全吗？其实也未必。我曾经听过交易所界一些很普遍被打进去的案例。

交易所的数据库被从网站上开后门，黑客改不了数据，但能读数据，而 Google 演算法的二步验证的用户种子，是明码写在数据库里面的，Google 演算法是公开的，所以黑客一样可以算出真正的通行密码。有加密等于没有加密。

### 防护手段二：IP 阻挡与第三方验证

这就让我们引到了下一个手段，三步确认用户行为。

使用者的密码虽然是有可能撞库被泄漏。

但是还是有办法去放缓黑客的攻击的。

#### 1. IP 验证与尝试次数

黑客用的多半是跳板 IP。所以 IP 要不是从奇怪的小国过来，就是会与用户平常惯用的 IP 非常不同。

作为系统防御者，你可以设置不同 IP 尝试错误次数超过3-5次，就自动发信警告用户。

如果就算成功，因为登入 IP 网段不同，还是要通知用户有不同 IP 灯入。

再来，作为降速手段，密码正确之后，还要加入一道图形验证码，防止用户被程序自动攻破。

而如果用户真的被成功登入，进行关键敏感操作（如提现或提币），必须间隔 2-5 分钟以上才能操作，并且要有第三道确认。

这是为了争取让有些用户，有时间差可以反应阻挡攻击。

#### 2. 第二道密码以及通知用户确认

支付宝在设计上，有分登入密码，与取款密码。

这也是防止用户因为一道密码与设备被连环攻破，会带来的连环损失。

在币所的实务上，在取款时，我们也会加上 email 确认，确保用户是经过至少四道以上的确认是本人，才能进行金额上的操作。

#### 3. IP 切换，cookie 立即作废，自动强制登出使用者

有些服务，是设计来钓鱼使用者的 cookie 的。

比较好的设计是：

* 一个帐号只能同时有一个 IP 登入
* 当 IP 切换立刻会被强制登出


## 被动思考：用户资料的价值性在哪里？

每个互联网服务储存的用户价值性都不同。有的互联网用户资料有价值的部分只有「密码」，有的是「个资」。

交易所之所以是黑客眼中的肥羊，是因为交易所有里面用户的「个资」与「资产」。

黑客会向交易所攻击的部分：

* 针对单个用户：想办法拿到 KYC 资料，以及提走币
* 针对交易所：想办法拿到大量 KYC 资料，变身为用户领走资产，改交易所数据库合法提领资产，等等等等...

所以当在施行防护措施时，开发者得去思考，一个用户在站上的价值资料在哪里。

如何让真的「本人用户」能存取到，而只有「密码」却什么都存取不到。

我认为这是开发者最先要去思考的第一个课题。

如果用户密码一定会被撞库，那么你要如何让损失降到最低？

或者是退而求其次，站方与被盗用户同时间，有机会阻挡攻击。

## 主动切断攻击

上面我们谈的都是被动防御攻击。但事实上，我们可以主动防御攻击。

因为目前黑客多半不是手工作业。而都是自动作业。而且是非常精密的全自动作业。

通常黑客的攻击手法是分几阶段的：

1. 利用自动攻击工具，锁定漏洞多的互联网服务，并且自动夺取服务器控制权
2. 锁定目标后，由黑客亲自出马，绕过系统特定设计，实际夺取控制权

这方面粗步的阻挡有几种方式：

1. 采购 Web Application Firewall。WAF 防火墙与一般防火墙的不同在于，这些自动攻击工具，都是有 pattern 的，会专注在于 XSS、SQL Injection、Directory Traversal Attacks。WAF 能够识别这些攻击特征与 IP 频率，主动阻拦尝试。
2. 网站 IP 白名单。发起攻击的国家跳板 IP 固定是某些国家，比如说是俄罗斯。如果你很确定你没有想要服务来自俄罗斯的用户，直接从防火墙上面干掉是最一劳永逸的事。
3. 添加一层负载平衡器。提供服务的机器永远不要直接面临外网，而是透过负载平衡器切换流量，避免直接被攻击的可能性。
4. 租用 CDN。现在的 CDN 通常也有防止恶意攻击的侦测，可以主动阻断一些可疑的流量。

有一些 WAF 做的比较细致的，还可以整合网站应用。当发现有用户被盗帐号，频繁登入，可以直接锁住帐号。或者这些 WAF，甚至可以发现网站第三方库有 security patch，直接通知开发者升级补丁。

## 总结

这里总结一下你现在可以主动做的事：

1. 将外围架构的 WAF 架好，阻绝第一层试探性的攻击
2. 列出一份站上用户的「有效资源清单」，如何让非本人盗号者，第一时间拿不到这些信息。
3. 用户动用敏感信息，你会用至少哪三个手段，确认真的是本人。
4. 如何鉴定使用者不是本人？如何发现之后能够有效切断访问？
